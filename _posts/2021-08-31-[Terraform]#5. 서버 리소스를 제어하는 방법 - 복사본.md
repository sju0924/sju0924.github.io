---
title: '[terraform]#5. 서버 리소스를 제어하는 방법'
categories: [study]
comments: true
---

# 1. 서버 리소스 제어를 위한 기본 API
## 서버 리소스
서버 리소스에는 `타입` 과 `이미지` 라는 구성 요소가 있다. `서버 리소스` 란 기동하거나 정지하는 서버를 의미하며, `인스턴스` 라 부르기도 한다. 
* `타입` 은 리소스의 크기나 속성을 몇 가지 유형으로 정리한 것이다. 아마존 EC2에서는 인스턴스 유형이라 한다.
* `이미지` 는 서버의 기동 이미지로, AWS에서는 AMI에 해당한다.

리소스들의 연관 관계를 정리해보자면 서버는 반드시 하나의 타입과 이미지로 생성되고, 반면 한 타입과 이미지는 여러 서버를 만들 때 사용될 수 있다.

## 서버 리소스와 API
URL 로 API 를 제어할 때, 각 리소스들에 부여된 고유 ID(대개 UUID) 를 URL 에 포함시켜 API 조건으로 지정하면 해당 리소스에만 API 가 동작하게 제어할 수 있다.

## 가상 서버 생성을 위한 API 처리 흐름
오픈스택 nova 명령의 흐름을 따라가면서 API 동작을 살펴보았다.
* 인증

>https://{identity}/v2.0/tokens

URI를 POST 방식으로 호출한다. {identity}에는 Keystone 서비스를 제공하는 서버의 접속 정보가 들어간다. 또 POST 로 전송된 데이터에는 인증에 필요한 username과 password 가들어있다. 이 API 요청이 성공하면 사용자에게 토큰과 엔드포인트에 대한 정보가 응답으로 돌아온다. `토큰` 은 인증 이후의 각종 처리를 할 때 때 인증 정보로 사용하는 문자열이다. `엔드포인트`는 API를 제공하는 서버의 접점을 URI 로 표현한 것이다. 오픈스택에서는 기능별로 API들이 분리되어 있고 서버도 분리되어 있다. 즉, 기능에 따라 엔드포인트도 다르다. `Keystone` 은 API의 접점 정보들을 엔드포인트로 관리한다. 그래서 사용자가 인증에 성공하면 접속할 엔드포인트를 알려준다. 그래서 인증 이후의 URL 호출을 살펴보면 {identity}가 {compute}로 바뀐다. 이 예에서는 가상 서버를 만드는 것이 목적이어서 서버 리소스를 관리하는 API 의 엔드포인트가 compute로 바뀐다.

* 템플릿 이미지의 유효성 검증

> https://{compute}/v2/{tenant_id}/images/{image_id}

URI 를 GET 방식으로 호출한다.{compute} 부분에는 Nova의 접속 정보가 들어가고, {image_id} 에는 CLI 명령을 실행할 때 업션으로 설정된 템플릿 이미지의 UUID가 들어간다. 이 API 는 템플릿 이미지에 대한 정보를 가져오고 만약 존재하지 않거나 접근 권한이 없는 경우 에러로 응답한다.

* 가상 서버의 생성
> https://{compute}/v2/{tenant_id}/servers

URI를 POST 방식으로 호출한다. 이 때 요청 바디에는 생성할 가상 서버의 조건 정보가 들어 있다. 오픈스택은 서버에 대한 조건 정보를 받은 후 응답으로 UUID를 리턴한다. 이 시점에는 아직 서버가 만들어 지지 않았고, 수 초에서 수 분 후에 서버가 완성된다. 그 후 리턴받은 UUID를 사용하면 서버를 지정하여 사용할 수 있다.

* 생성된 가상 서버의 상태 확인
> https://{compute}/v2/{tenant_id}/servers/{server_id}

{server_id} 에는 생성된 가상 서버의 UUID 가 들어간다. 이 URI 를 GET 방식으로 호출하면 해당 가상 서버에 대한 상세 정보를 받을 수 있다.<br><br>
클라우드에서는 어떤 리소스의 정보에 변화를 줄 때 POST 방식 메소드를 사용하고 기본적으로는 비동기 방식으로 동작한다. 또한 GET 방식의 메소드를 사용할 경우 찾는 리소스가 존재하기만 하면 그 즉시 결과를 받아볼 수 있어, API로 리소스 제어 시 이 두 가지 방법을 조합한다. 우선 POST로 리소스 제어 요청을 보낸 후 처리 완료될 때까지 GET으로 리소스를 계속 반복하여 확인한다.
## 가상 서버의 수명 주기

## 메타 데이터와 사용자 데이터
> 가상 서버의 환경 설정에 활용되는 데이터

`메타 데이터` 는 생성된 서버에 대한 관리 정보나 사용자가 임의로 정한 데이터가 들어간다. AWS에서는 가상 서버의 로컬 IP 주소를 통해 메타 데이터를 확인할 수 있다. 서버별로 따로 만들어지고 여러 서버가 같은 메타 데이터를 공유하진 못한다. 또한 각종 프로그램의 파라미터로 활용되는데 주로 자동화 스크립트나 구성 관리 정보에 활용된다. <br>
`사용자 데이터` 는 가상 서버에 액션을 실행해야 할 때 사용한다. 대표적인 사용 예로는 쉘 스크립트가 있다.

## 이미지 생성과 공유
`이미지` 란 가상 머신의 템플릿 이미지를 의미한다. AWS에서는 CreateImage API 에 인스턴스 ID 를 지정하여 기동 중인 서버의 이미지를 만들수 있고 DescribeImages API로 이미지 정보를 얻어올 수 있다.

## VM 이미지 가져오기
다른 서버 가상 환경의 가상 머신이나 다른 클ㄹ라우드 환경의 이미지를 사용하고 싶을 때, 이미지를 import하는 API를 제공한다. AWS에서는 ImportImage, ImportInstance, ImportVolume 과 같이 VM을 임포트하는 API 가 제공된다.
* ImportImage 는 가상 머신 템플릿을 AMI로 등록한다.
* ImportInstance는 AMI를 등록하고 서버 기동까지 한 번에 해치운다.
* ImportVolume 은 볼륨이 분할되어 있는 경우 볼륨 단위로 임포트한다.

# 서버 리소스의 내부 구성
## 가상 서버가 생성되기까지 처리 흐름
* 가상 서버 생성 요청을 메시지 큐에 넣기

가상 서버를 생성하는 API 가 실행되면 큐에 메시지를 넣어 비동기로 처리한다. 

* 스케줄러에 요청 전달하기

메시지 큐에 들어간 생성 요청 메시지는 스케줄러, 혹은 컨덕터라고 부르는 프로세스가 꺼낸다. 이후 가상 서버를 생성하기 위한 처리를 시작한다. 

* 가상 서버를 기동할 호스트 결정하기

오픈스택은 가상 서버를 배치할 호스트를 자동으로 처리한다. 스케줄러는 호스트를 선택할 때 기본 항목으로 CPU 코어 개수와 메모리 용량 등을 고려한다. 

* 호스트에 가상 서버 기동을 지시하기.

서버를 기동할 호스트를 결정했다면 호스트에 가상 서버를 기동하도록 지시한다. 기동 지시 메시지는 메시지 큐에 들어간다.

* 메시지 수신과 가상 서버 생성하기

호스트는 가상 서버를 만들고, 생성하는 것 이외에도 기동할 템플릿 이미지를 가져오고 가상 서버에 할당할 IP 주소를 확보하는 작업, 지정한 네트워크로 접속하기 위한 준비 등의 다양한 작업들을 처리한다. 

* 가상 서버의 상태 갱신하기

가상 서버를 생성하고 기동까지 성공했다면 상태를 ACTIVE로 갱신한다.

