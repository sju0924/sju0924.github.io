---
title: '[terraform]#7 네트워크 리소스를 제어하는 방법'
categories: [study]
comments: true
---



# 1. 네트워크 리소스의 제어를 위한 기본 API

## 클라우드 네트워크의 특징과 기본 사상
네트워크의 기본은 TCP/IP이다. 클라우드 네트워크는 편리한 기능이 더 많은데, L3 네트워크는 클라우드 내외부를 연결하는 기능을 하기도 한다. 또 방화벽 기능이나 접근 제어, 부하분산, VPN 기능 등도 적용할 수 있다. 네트워크 리소스 중에서도 2,3계층을 중심으로 살펴본다. 네트워크에서 중요한 포인트인 IP 주소 관리 기능이 클라우드 환경에서는 기본적으로 포함되어 있다. IP 중복 방지 등 관리를 시스템이 자동으로 처리하고, 주소 할등을 DHCP로 받아가도록 만들어져 있다. 확장성이나 오토스케일링, 오토힐링 등 클라우드의 장점을 살리려면 시스템 구성 시 IP 주소 정보에 종속되지 않도록 설계하는게 중요하다.

## 네트워크 리소스의 전체 그림
네트워크 부분에서는 오픈스택과 AWS 사이에 모델링 방식에서 일부 차이가 있다. AWS 중심으로 살펴보려 한다.

### 기능 매핑

AWS에서는 가상 네트워크 전체에 해당하는 VPC에 리소스를 먼저 만든 후, 그 안에 서브넷, 라우팅 테이블, ENI를 구성한다. 오픈스택이 가상 스위치, 라우터 등 물리 장비를 흉내냈다면 AWS는 논리적인 네트워크의 기능을 모델로 표한한다.

### 오픈스택과 AWS의 네트워크 리소스 비교

|네트워크 리소스|오픈스택 Neutron|AWS VPC|
|---|---|---|
|네트워크 전체|-|VPC|
|스위치|네트워크|서브넷|
|라우터|라우터|게이트웨이, 라우팅 테이블|
|포트|포트|ENI|
|시큐리티 그룹|시큐리티 그룹|시큐리티 그룹|
|네트워크 접근 제어|(개발중)|네트워크 액세스 컨트롤 리스트|

## 스위치와 서브넷
### 스위치

L2 네트워크 기능을 수행한다. 가상 스위치에서는 3계층에서 사용하는 IP 주소 범위를 `서브넷` 이라는 이름으로 할당받는다. IP 주소 범위는 사용자가 자유롭게 정의 가능하다. 클라우드 네트워크는 서로 완전히 분리되어 있어 직접 연결만 안 돼 있다면 IP가 중복되어도 무방하다. AWS VPC에서는, 가상 스위치에 대응하는 리소스는 없고 서브넷에 그 개념과 기능이 함께 녹아 있다. 가상 스위치와 서브넷은 1:1 관계이고 TCP/IP 사용이 전제되면 서브넷만 정의하더라도 무관하기 때문이다. IP 주소 범위는 보통 VPC 생성 시 거기에서 사용할 IP주소 범위를 우선 정하고 이후 서브넷을 생성할 때 IP 주소 범위 안에서 서브넷에 사용할 범위를 선택하는 방식으로 총 두 번에 걸쳐 정의한다. VPC 안에서는 여러 서브넷을 만들 수 있지만 확보한 IP 주소 범위는 못 바꾸니 여유 있게 정할 필요가 있다.

### 서브넷
서브넷에 연결된 서버는 DHCP로 IP 주소를 할당 받아 통신한다. 다만 기동될 때마다 달라지지는 않는다. 따라서 이를 고정 IP라 한다. 이러한 서브넷은 할당된 IP 주소에만 통신을 허용한다는 특징이 있어 임의로 IP 주소를 바꾸면 변경된 IP 주소로는 통신하지 못한다.

#### IP 주소의 범위
서브넷을 생성할 때 지정하는 IP 주소의 범위를 `CIDR` 라 부른다. 클래스 A,B,C등으로 나눈 것보다 효율적으로 사용하기 위해 도입되었고, 가변 길이로 서브넷 마스크를 할당한다. 이 때 도입된 방식이 주소 뒤에 /비트 수를 붙여 서브넷 마스크의 길이를 표현하는 것이고, 이를 CIDR 방식이라 부른다. 

## 라우터

라우터는 서로 다른 네트워크를 연결하는 기능을 한다. 이는 세 가지 연결 방식이 있다.

* 내부->내부

이는 서로 다른 네트워크에 속한 서버끼리 통신하는 것이다. 기본적으로 테넌트 내부나 VPC 내의 네트워크들을 서로 연결하게 된다. 경우에 다라 서로 다른 테넌트의 네트워크와 테넌트의 경계를 넘나들며 라우팅해야 할 수도 있는데 AWS에서는 VPC Peering에서 이 기능을 제공한다.

* 내부->외부

이는 클라우드의 사설 네트워크와 인터넷같은 외부 네트워크를 연결한다. 이 때 라우터에서는 내부에서 사용되는 사설 IP를 공인 IP로 변환하는 IP 마스커레이드를 하게 된다.

* 외부->내부

외부 네트워크에서 클라우드 내의 서버에 접근한다. AWS에서는 EIP가 사용된다. 이는 공인 IP를 어드레스 풀에서 확보하고, 서버의 논리 포트에 할당한 뒤 다시 이 공인 IP 주소가 사설 IP주소로 연결되도록 한다. 이런 기능을 NAT라고 한다.

### 실제 리소스

VPC의 가상 라우터는 크게 게이트웨이와 라우팅 테이블로 구성된다. AWS에서는 외부로 연결하려 VPC안에 게이트웨이를 만든다. 그 후 서브넷의 라우팅 테이블에서 외부로 통신할 때 이 게이트웨이를 통과하도록 라우팅 정보를 설정해준다. 게이트웨이는 역할에 따라 몇 가지 분류가 가능하다. 인터넷 통신을 위한 인터넷 게이트웨이, 거점과 사설 네트워크 통신을 하기 위한 버추얼 게이트웨이, 리전 안에서 서로 다른 VPC끼리 연결하기 위한 피어링 커넥션, 인터넷에 연결된 매니지드 서비스에 VPC에서 인터넷을 경유하지 않고 연결하기 위한 VPC 엔드포인트 등으로 나눌 수 있다.<br>
AWS에서는 개념적으로 라우터가 VPC에 속하는 형태이지만 라우터가 리소스 형태로 관리되진 않는다. 대신 라우터에 설정하는 `라우팅 테이블`을 리소스 형태로 사용한다. 이는 VPC 전채와 개별 서브넷에만 적용할 수 있는데, 전자를 메인 라우팅 테이블, 후자를 서브 라우팅 테이블이라 한다.

## 포트

논리 포트는 가상 네트워크상에 만들어지는 스위치의 포트 같은 개념이다. AWS에서는 서버에서 네트워크에 연결하기 위한 인터페이스 접점이라는 의미가 강하고 ENI라 한다. 물리 환경에서는 스위치가 단순히 전기적 신호를 주고 받는 역할이었다면 논리 포트는 몇 가지 기능이 더 추가된다. 논리 포트는 생성될 때 서브넷으로부터 IP 주소를 할당받고, 이외의 IP 주소 통신은 모두 차단시킨다. IP 주소를 여러개 할당할 수도 있다. 또한 하나의 가상 서버에 여러 논리 포트를 할당할 수 있다. 가상 서버의 논리 포트는 자유롭게 추가/제거할 수 있다. 하지만 기본적으로 할당되는 ENI를 eth0 이라 하여 서버에서 제거하지 못하도록 해 통신할 수 있게 하고, 나머지는 자유롭게 작업할 수 있다. 그래서 한 서버에서 사용하는 포트를 다른 서버에 붙여 주면 같은 IP주소로 다른 서버로 접속하게 할 수 있다. <br>
또한 가상 네트워크와 가상 라우터를 연결할 때도 사용할 수 있다. 이 때 논리 포트에 할당된 IP 주소는 가상 서브넷의 게이트웨이 역할을 한다. 비슷한 방식으로 EIP도 논리 포트에 해당된다. EIP로 들어오는 요청은 가상 라우터에 의해 NAT 처리되어 논리 포트의 IP 주소로 전달된다. 또한 논리 포트는 MAC 주소도 가진다.

## 시큐리티 그룹

가상 서버에 들어가고 나가는 트래픽을 필터링한다. 서버의 인터페이스 단위로 세부 패킷 제어도 할 수 있다. 논리포트 단위로 적용되고, 아무런 설정을 하지 않으면 모든 트래픽을 폐기해 허가하고 싶은 트래픽에 대해 방화벽 규칙을 등록해야 한다. 클라우드 테넌트 네트워크 관리 관점에서 보면 시큐리트 그룹의 적용을 네트워크 차원에서 한다는 개념이 상당히 중요하다. 가상 서버 OS나 애플리케이션과 종속 관계가 없어 보안 정책 관리나 적용을 손쉽게 할 수 있다.

### 규칙

방화벽 규칙에는 트래픽의 방향, 프로토콜 종류, 포트 번호, 통신 상대를 지정할 수 있다.

* 통신 상대

입력일때는 송신지, 출력일때는 수신지를 의미한다. 상대의 IP주소 범위를 지정하거나, 또 다른 시큐리티 그룹으로 통신 상대를 지정할 수 있다. 시큐리티 그룹을 지정하면 저장된 시큐리티 그룹에 속하는 모든 가상 서버들을 통신 상대로 인식한다. 이를 논리 포트에 할당하면 시큐리티 그룹의 방화벽 규칙이 논리 포트에 적용된다. 한 논리 포트에는 여러 시큐리티 그룹을 지정할 수 있고, 하나라도 맞는 것이 있다면 통식을 허용한다. 이를 암묵적 Deny 정책이라 한다. 또한 한 시큐리티 그룹을 여러 논리 포트에 지정하는 것도 가능하다.

### 방화벽 규칙에 시큐리티 그룹 지정하기
클라우드에서 특정 역할을 하는 서버의 대수를 늘리거나 줄일 때, 통신 상대를 시큐리티 그룹으로 지정하면 효율적인 관리가 가능하다. 웹 서버를 위한 시큐리티 그룹을 적용하면, 일관적인 규칙 적용이 가능하고 웹 서버를 대표할 또 다른 그룹을 만들지 않아도 된다.

## 네트워크 액세스 컨트롤 리스트
서브넷에 대한 필터링 기능을 한다. 명시적으로 패킷 필터링을 하거나 권한을 분리하는 것이 가능하다. 시큐리티 그룹과의 차이점은 NACL은 기본 설정이 암묵적으로 접근을 허가한다. 접근 제어는 스테이트에 따라 동작 방식이 달라질 수 있다. 스테이트는 통신에 대한 허용 여부 정보에 대한 상태라고 생각하면 된다. NACL의 규칙은 상태가 없다. 시큐리티 그룹은 상태가 있다.

# 네트워크 리소스와 API
## 네트워크를 구성하기 위한 API의 처리 흐름
AWS에서는 VPC를 만드는 CreateVPC API를 호출하고, CreateSubnet 이나 CreateNetworkInterface API를 호출한다. CIDR같은 정보는 쿼리 파라미터에 지정하고 응답이 JSON으로 오기 때문에 오케스트레이션 기능과 조합할 수도 있다. 이후 논리 포트를 가상 서버를 연결하면 통신이 가능하다.

# 네트워크 리소스의 컴포넌트
네트워크 리소스는 `스위치`, `서브넷`, `라우터`, `포트`, `시큐리티 그룹`, `NACL` 로 구성된다. 클라우드 환경에서 AWS에서 여러 VPC가 여러 NACL을 가지고, 한 VPC가 여러 Subnet을 가질 수 있고, Subnet 은 여러 ENI를 가질 수 있으며 여러 ENI가 여러 시큐리티 그룹을 가질 수 있다. 클라우드 환경에서 네트워크 시큐리티는 상당히 중요한 부분이다. 따라서 대규모 시스템 구축 시 네트워크 설계와 필터링 정책 검토가 필요하다. 특하 시큐리티 그룹과 NACL은 설정에 대한 자유도가 높고 N:N 관계를 만들 수 있어 설계에 대한 고민이 필요하다. 네트워크에 대한 이해와 효율적인 업무 수행을 위해서 `SDN`을 사용할 수 있다.

## 클라우드 서비스와 SDN
`SDN`은 기존의 환경에서 제어를 담당하는 컨트롤러와 전송을 담당하는 데이터 플랜을 분리해 API를 통해 이들을 제어하는 개념이다. SDN의 구성 요소들은 클라우드 네트워크 컨트롤러, 네트워크 오케스트레이터, 네트워크 장비이다. 네트워크 장비는 실제로 패킷을 다루는 장비로 API가 공개된다. 네트워크 오케스트레이터는 네트워크 장비를 제어하며 가상 네트워크의 다양한 기능들을 구현한다. 클라우드 네트워크 컨트롤러는 클라우드에서 가상 네트워크를 동작시키기 위해 태스크들을 실행시킨다. 컴퓨트 리소스에 비교하면 네트워크 오케스트레이터가 하이퍼바이저, 클라우드 네트워크 컨트롤러는 오픈스택 Nova이다. 또한 AWS VPC API 에 해당하는 역할도 있다. 사용자에게 일관된 API모델을 제공하는 것이다. AWS VPC는 SDN의 역할을 구현한다. 다만 이것이 어떤 형태로 설계되었는지 생각하고 이해할 필요가 있다.