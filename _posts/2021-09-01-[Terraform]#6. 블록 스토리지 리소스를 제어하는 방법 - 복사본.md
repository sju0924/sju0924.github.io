---
title: '[terraform]#6 블록 스토리지 리소스를 제어하는 방법'
categories: [study]
comments: true
---



# 1. 블록 스토리지 리소스의 제어를 위한 기본 API

## 블록 스토리지 리소스
블록 스토리지 리소스는 크게 `볼륨` 과 `스냅샷` 의 두 종류로 구분된다. `볼륨` 은 실제로 서버에 연결되는 디스크를 의미하고 휘발되지 않고 영속적으로 보관되는 특징이 있다. `스냅샷`은 볼륨을 복제한 것으로 스냅샷 자체로는 서버에 직접 연결해서 쓰지 못한다. 서버에 사용하려면 일단 스냅샷을 다시 볼륨으로 복원한 후, 서버에 연결해야 한다.

## 블록 스토리지와 API 
AWS에서 블록 스토리지는 EBS이다. 이 스토리지를 제어하는 명령은 ec2 명령에 포함되어 있다. 이 명령을 실행하면 관련된 여러 API들이 실행된다. API의 처리 흐름은 아래와 같다.

* 볼륨의 생성

오픈스택의 경우, KeyStone의 API로 인증이 성공하면 Cinder에서 https://{storage}/v2/{tenant_id}/volumes를 POST 방식으로 호출하고 볼륨이 만들어진다. 그 결과 생성된 볼륨의 UUID 정보가 전달된다. 이 때 실행된 API 는 POST 방식을 사용했기 때문에 비동기로 처리되지만, 모두 비동기식으로 호출되지는 않는다. 볼륨 생성 요청이 완료되면 사용자에게 UUID 정보가 전달되는데 이 시점에서는 볼륨이 다 만들어지지 않았을 수 있다. 볼륨의 상태가 Available 이 되는 것을 확인한 후에야 다음 처리로 넘어갈 수 있다. 이 때 확인하는 것은 가상 서버 상태 확인과 비슷하게 GET 방식으로 http://{storage}/v2/{tenant_id}/volumes/{volume_id} 를 호출한다. 아마존 EBS를 사용할 경우에는 가상 서버와 블록 스토리지가 같은 EC2 서비스에 포함되어 있기 때문에 API를 제공하는 엔드포인트가 동일하다. 볼륨을 생성할 때 CreateVolume API를 사용하게 되는데 그 결과 고유한 볼륨 ID가 응답으로 되돌아온다. 이후 볼륨의 상태를 확인할 때 볼륨 id를 파라미터로 DescribeVolumes API를 GET 방식으로 사용한다.

* 볼륨과 가상 서버의 연결

볼륨이 만들어졌다면 이를 가상 서버와 연결해야 한다. 이 작업을 `Attach` 라고 한다. 오픈스택에서는 https://{compute}/v2/{tenant_id}/servers/{server_id}/os-volume_attachments를 POST 방식으로 호출한다. 이 역시 POST 방식으로 요청되어 비동기로 처리되기 때문에, API 호출 직후에 응답이 왔다고 하더라도 그 시점에서는 완전히 연결이 끝나지 않았을 수도 있다는 점에 주의해야 한다. 그래서 연결 처리가 완료되었는지 확인하는 GET 호출이 필요하다. 볼륨과 가상 서버의 연결이 실패했다면, 원인을 살펴봐야 하는데 자주 발생하는 에러는 서버와 볼륨이 서로 다른 가용 영역에 만들어진 경우이다. <br>
AWS에서도 볼륨을 연결할 때 가상 서버를 대상으로 `AttachVolume` API를 실행한다.이 때 가상 서버를 지정하는 인스턴스 ID와 볼륨을 지정하는 볼륨 ID, 디바이스명을 쿼리 파라미터로 전달한다.

## 볼륨 타입

블록 스토리지의 백엔드는 물리적 디스크여서, 디스크의 특성과 설정에 따라 I/O 특성도 달라진다. 클라우드 환경에서는 볼륨 타입이라는 카테고리로 명시적으로 선택할 수 있다. Amazon EBS 를 사용하면 물리적 디스크의 사양 정보가 사용자에게 노출되지 않아, AWS가 미리 정의해둔 디스크 타입에서 볼륨을 선택해야 한다. Magnetics 타임을 시작으로 범용적인 SSD, IOPS를 지정할 수 있는 Provisioned IOPS까지 모두 세 종류의 블록 스토리지중에서 원하는 것을 고를 수 있다.

## 볼륨 사이즈
볼륨 사이즈는 볼륨을 생성할 때 결정한다. AWS에서는 CreateVolume API의 size 파라미터로 GB단위로 지정할 수 있다. 오픈스택에서는 볼륨의 용량을 변경하고 싶을 때 URI로 POST 방식으로 요청한다. Amazon EBS의 경우 서비스에 따라 상한 값이 정해져 있다. Magnetic 타입을 제외하고는 하나의 EBS 볼륨당 16TB가 상한값이다.

## 스루풋, IOPS, SR-IOV
클라우드에서는 가상 서버 리소스가 블록 스토리지로 접근하기 위해 네트워크를 통과해야 해서, 가상 서버에서 블록 스토리지까지 연결되는 네트워크의 성능도 중요하다. 이 때 성능을 가늠하기 위한 지표로 `스루풋`(초당 전송 대역), `IOPS`(초당 입출력의 횟수) 를 사용한다. 아마존 EBS 의 경우 IOPS가 볼륨 타입에 따라 달라진다. Magnetics는 평균 100IOPS 정도, SSD타입은 최대 10000IOPS 까지 나온다. 보통 SSD 타입에서 IOPS 를 올릴려면, 용량을 많이 할당하여 IOPS를 높이는 방법을 쓰기도 한다. 3TB까지 IOPS가 늘어난다. 이 이상 늘어나면 볼륨을 분할하는 것이 유리하다. Provisioned IOPS 타입에서는 CreateVolume API로 IOPS 파라미터를 통해 직접 설정할 수 있다. `스루풋` 의 상한 값에 대해서는, 역시 볼륨 타입에 따라 다르다. Magnetic의 경우 초당 40~90MB, SSD는 초당 160MB, Provisioned IOPS에서는 초당 320 MB 정도가 나온다. 볼륨을 대량으로 연결시켜 전체적인 스루풋을 향상시킬수는 있지만 거꾸로 서버 측 네트워크에 병목이 걸릴 수 있다. EC2에서는 인스턴스 유형에 따라 최대 스루풋이 결정되는데, 만약 병목이 발생하고 있다면 인스턴시 유형을 상위의 것으로 바꿔줘야 한다. 블록 스토리지는 네트워크를 경유해 접근하기 때문에 시스템 구성 방식이 원인이 되어 병목이 발생할 수도 있다. 이럴 경우, `SR-IOV`를 사용해도 된다. SR-IOV는 가상화된 환경에서 여러 대의 가상 머신이 하이퍼바이저를 통해 처리하던 것을 PCI 디바이스가 처리하도록 만들어 하이퍼바이저에서 발생할 수 잇는 병목을 제거하는 기법이다.

## 스냅샷, 백업 클론
* `스냅샷` 은 특정 시점에 볼륨에 기록된 블록 단위의 데이터를 보존하는 것으로 저장 속도가 상당히 빠른 것이 특징이다.
* `백업`은 볼륨에 저장된 데이터를 내구성이 높은 오브젝트 스토리지에 보존하는 것이다.
* `클론`은 볼륨을 직접 복제하는 것이다.

Amazon EBS 에서는 스냅샷을 만들기 위해 CreateSnapshot API를 실행한다. 내부적으로는 S3에 저장되어 백업을 하는 것과 같은 효과가 난다. EBS의 스냅샷은 블록 수준에서 만들어져서 같은 볼륨에 대해 두 번 이상 스냅샷을 만들면 앞에서 만든 블록에 대한 변경된 부분만 S3에 보내진다. 클ㄹ론에 해당하는 기능은 2015년 시점에서는 AWS에 존재하지 않아, 스냅샷을 일단 만든 다음 그 스냅샷에서 블록을 생성하는 방법을 사용해야 한다. 대신 AWS에는 스냅샷을 복제하는 기능이 있고 리전을 넘나들 수 있다. EBS는 AMI를 공개하는 것처럼 스냅샷도 공개할 수 있다.

## 스냅샷과 이미지의 관계
블록 스토리지의 내구성이 좋아 루트 볼륨에 이페머럴 스토리지를 사용하지 않고 블록 스토리지를 대신 사용하는 경우가 종종 있다. 이 책에서는 이페머럴 스토리지는 AWS에서 인스턴스 스토어, 블록 스토리지는 EBS라고 이해하면 된다. 이미지를 이용해 가상 머신을 기동하는 방법과 블록 스토리를 이용해서 기동하는 방법의 차이를 살펴보자면, 이미지는 서버를 기동할 때 사용되고 스냅샷은 볼륨을 기동할 때 사용된다. 루트 볼륨 하나만으로 리눅스 서버를 기동한다면 두 경우가 크게 다르지 않지만, 이미지를 사용한 방법은 여러 스냅샷을 함께 다루며 블록 디바이스와의 매핑 관걔도정의할 수 있다. 블록 디바이스를 매핑한 내용애 따라 여러 스냅샷을 원하는 마운트 포인트에 연결시켜서 가상 서버를 만들 수 있다.

# 2. 블록 스토리지의 내부 구성
가상 서버와 볼륨을 연결하는 API는 좀 다른 방식으로 동작한다. 이 둘을 연결하려면 가상 서버와 스토리지 각각의 API를 연계해야 하기 때문이다. 오픈스택의 예시로 살펴볼 것이다.

## 가상 서버와 블록 스토리지의 연결
사용자는 가상 서버와 볼륨을 연결하기 위해 가상 서버를 제어하는 API인 https://{compute}를 호출한다. 연결 요청이 접수되면 일단 메시지 큐에 요청 메시지를 넣게 되고 이후 스케줄러가 하이퍼바이저를 선택하고 하이퍼바이저가 연결 처리를 한다. 좀 더 구체적으로 각 하이퍼바이저 안에는 오픈스택 에이전트가 실행되고 잇으며 이 에이전트 프로세스가 큐에 등록된 연결 요청 메시지를 꺼내간다. 이때, 하나의 하이퍼바이저에서 끝낼 수 있으면 에이전트가 그 하이퍼바이저에서 작업을 처리하게 한다. 하이퍼바이저 외에도 스토리지와 연결해야 하면 블록 스토리지 리소스를 제어하는 엔드포인트를 통해 API를 호출하여 서버와 스토리지 연결에 필요한 일종의 협상 과정을 시작한다.연결 요청을 받은 에이전트가 스토리지를 제어하기 위한 API를 실행하고, 요청을 받은 엔드포인트는 볼륨을 연결하도록 준비 작업을 하고 가상 서버와 볼륨 각각의 준비가 완료되면 둘을 연결한다.

## 서로 다른 인프라 리소스 간의 자동 협상

위 문단 이후부터 시작한다. 하이퍼바이저의 에이전트가 위 연결 요청 aPI를 접수한 후, 이후 실행되는 API는 모두 https://{storage}/v1/{tenant_id}/volumes/{volume_id}/action 에 대해 POST 방식으로 실행되고 있다. 엔드포인트는 같지만 서로 다른 데이터가 전달되고 있다.

* 볼륨 예약

접속 요청을 받은 하이퍼바이저는 우선 스토리지의 API를 통해 사용할 볼륨을 예약한다. 이는 운영체제에서 lock을 거는 것과 같다. 요청한 볼륨이 사용 중이면 에러를 발생시킨다. 예약에 성공하면 볼륨의 상태가 available 에서 attaching으로 바뀌고, 이 때 볼륨의 상태는 API로 확인할 수 있다.

* 연결 준비

예약에 성공했다면 이번에는 하이퍼바이저 측의 정보를 스토리지 측에 전달하여 접속 준비를 한다.정보를 받은 스토리지는 볼륨으로 연결할 수 있도록 설정 작업을 한다.

* 실제 접속 처리

스토리지 측 준비가 끝나면 가상 서버와 볼륨의 연결이 실제로 이루어진다.

* 연결 성공 통보

볼륨 연결이 성공하면 하이퍼바이저가 스토리지 측으로 연결 성공 사실을 통보한다. 이 API가 실행되면 볼륨 상태가 attaching에서 in-use로 변경된다.

## 클라우드 내부에서도 사용되는 aOI

위 내용을 보면 인프라의 리소스들이 추상화되어 있고 필요 기능들이 API로 제공돼서 프로그램 가느이 연계도 쉽게 되는 것을 알 수 있다. 리소스 간의 협상 과정은 오픈스택이 아니더라도 별도 프로그램을 개발하여 구현할 수 있다. 하지만 이들 프로그램은 리눅스 KVM 하이퍼바이저와 GLusterFS 스토리지에 특화되어 만들어져 있어 다른 하이퍼바이저나 스토리지를 사용할 경우 프로그램을 수정해야 한다.

# 3. 블록 스토리지 리소스 조작할 때 주의사항
API를 사용하면 스토리지 기능이 추상화되어 특정 스토리지 제품의 하드웨어나 소프트웨어의 차별성해 대해 신경 쓰지 않아도 된다는 장점이 있지만 그 스토리지 제품만이 가진 고유의 기능은 써보지 못한다는 단점이 있다. 하지만 크게 걱정하지 않아도 되는 것은 스토리지가 가지고 있는 고도의 기능들이 OS의 파일 시스템이나 논리 볼륨 기능으로도 대체가 가능하다는 점이다.<br>
이전의 물리적 환경에서는 스토리지 제품이 제공하는 기능만 잘 활용하면 시스템을 문제없이 구축할 수 있었지만 클라우드 환경에서는 그것만으로는 부족하다. 스토리지 API를 어떤 기능과 연계하면 더 안전하고 효율적일지, 그리고 어떻게 하면 자동화할 수 있을지 고민하고 설계해보는 노하우가 필요하다.<br>
클라우드 환경에서 API를 사용하는게 익숙한 젊은 엔지니어들은 API 형태로는 사용하기 어렵다는 이유로 써보지 못하고 숨겨지는 기능이 있을 수 있다는 것을 이해해햐 한다. 또한 특정 용도에서는 물리적 환경에서 제품 고유의 기능을 활용하는 것이 유리할 수 있다는 것도 알아야 한다.

# 4. 블록 스토리지 리소스의 컴포넌트
볼륨과 스냅샷과의 관계가 블록 스토리지의 근간이 된다. 하나의 볼륨이 여러 스냅샷과 관계를 맺고, 하나의 이미지가 여러 서버와 관계가 맺어진다. 하나의 서버에는 여러 볼륨을 연결할 수 있어 이미지->서버->볼륨->스냅샷과 같은 트리 형태의 구성이 만들어진다. 오픈소스에서는 리소스 형태로 볼륨과 분리된 볼륨 타입, QoS를 정의하는 반면 EBS에서는 볼륨과 스냅샷의 속성 안에 정의된다. EBS에서는 이미지와 스냅샷이 직접적인 관계로 연결되지는 않아서 ER 다이어그램의 중간 매핑 테이블 형태로 관계를 맺게 된다. AMI에는 블록 디바이스 매핑이라는 디바이스와 스냅샷 ID를 매핑하는 속성이 있다.표면적으로는 직접적인 관계가 없는 듯한 리소스들의 관계를 규명해야 할 때 이처럼 속성으로 연결되는 정보가 있는지 찾아보는 것도 좋은 방법이다.

# 5. 그 외 스토리지 기능
여러 대의 서버가 하나의 볼륨을 공유하는 형태를 만들기 위해, `NFS 서비스` 가 등장했다. AWS에서는 EFS가 이에 해당한다. 프로토콜로 마운트하는 방식으로 사용되며 접속 인터페이스와 관리형 공유 스토리지를 제공한다.