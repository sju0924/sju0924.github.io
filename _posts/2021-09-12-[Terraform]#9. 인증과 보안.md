---
title: '[terraform]#9.인증과 보안'
categories: [study]
comments: true
---

# 1. HTTPS

## HTTPS의 동작 방식

`HTTPS` 는 `HTTP`와 달리 통신 내용이 암호화되어 전달된다. 포트 펀호는 443번을 사용하고 TCP/IP에 5계층의 SSL/TLS를 적용하고 전자 인증서를 통해 통신 쌍방의 신뢰관계를 만든다. 도청이나 위변조를 막기 위해 API에는 기본적으로 HTTPS 프로토콜을 사용한다.

## 인증서

인증서는 서버 인증서와 클라이언트 인증서로 분류한다. 클라우드 환경에서는 클라우드의 신뢰성을 증명하기 위해 서버 인증서를 활용한다. 클라이언트 측에 대한 정보는 클라우드에서 제공하는 인증 기능을 사용하거나 HTTP 헤더의 유저 에이전트 정보들을 통해 알아낸다.<br>
통신 내용을 암복호화하려면 키가 필요한데, HTTPS는 공유 키 암호화 방식과 공개 키 암호화 방식을 조합한 하이브리드 암호화 방식을 사용한다. 처음에는 공유 키를 공개 키 암호화 방식으로 전달한 다음 전달된 공유 키를 사용해서 암호화 통신을 하게 된다. 클라우드의 엔드포인트에 서버 인증서가 설저오디어 있으므로 HTTPS로 API를 실행할 수 있다. 서버 인증서는 인증서의 사실상 표준인 Symantec사의 인증서를 사용하고, 이의 인증기관인 CA가 해당 도메인에 대한 신뢰 여부를 인증하게 된다. 이것은 서버의 URI에 대한 신뢰성을 인증하고, 접속하는 사용자를 인증하지는 않는다. 이는 뒤에서 알아보고,  한편 엔드포인트에 HTTPS가 적용되고 사용자 인증까지 더해지면 뒤에 설명할 `서명`프로세스가 가능해진다.


# 2. 사용자,그룹,롤,정책

사용자에 대한 인증을 처리하는 컴포넌트는 AWS에서는 IAM이 담당한다. 인증하는 단위와 권한 제어 방식에 대해 살펴보자.

## 테넌트

클라우드에는 최상위 개념으로 테넌트가 있다. 이 개념을 AWS에서는 어카운트라고 표현한다. 한 테넌트는 또 다른 테넌트와 완전히 격리되어 있다. 인증도 리소스의 하나이므로 적어도 하나의 테넌트에 반드시 속한다. 원칙적으로 여러 테넌트에 걸쳐서 인증하는 것을 불가능하다.

## 사용자

사용자는 API를 실행하게 만드는 사람을 의미한다. 사용자도 리소스 형태로 분류되어 API를 통해 생성, 변경, 삭제를 할 수 있다. 처음 클라우드 환경을 만들 때 리소스가 없으므로 사용자도 없는데, 클라우드를 어떻게 사용할까? 클라우드에는 테넌트와 연결된 특별한 관리자 계정이 있다. 리눅스에서는 root, 윈도우에서는 Administrator에 해당한다. 이는 권한이 막강해서 실제 운영시에는 사용하지 않는 것을 권장한다. AWS에서는 AWS 계정을 생성할 때 입력한 이메일 주소로 사용자를 식별하고 이를 기반으로 인증 정보를 다룬다. <br>
클라우드를 이용할 일반 사용자를 생성하는 방법은, AWS에서는 `CreateUser` API를 실행하면 된다. IAM이 리전에 속하지 않아서 리전 정보가 포함되어 있지 않은 https://iam.amazonaws.com/ 으로 실행해야 한다. 생성 직후에는 권한이 할당되지 않아 아무런 API도 실행시키지 못하므로 정책을 먼저 생성해줘야 한다.

## 그룹

사용자를 묶은 개념이다. 사용자를 그룹으로 묶어두면 그룹 단위로 정책을 할당할 수 있어 더 효율적으로 관리할 수 있다. AWS에서는 `CreateGroup` API를 호출하면 그룹이 생성되고 `AddUserToGroup` API를 호출하면 특정 그룹에 사용자를 할당할 수 있다.

## 정책

`정책`은 권한을 게어할 때 사용하는 기능이다. 적책을 적용하여 통제가 필요한 대상이 접근이나 실행을 제한하도록 한다. 정책은 JSON 형식으로 정의되고, 기본적으로 API를 제어한다. 즉 권한을 제어한다는 것은 곧 API의 접근과 실행을 제어한다는 것이다. 기본적으로 액션과 리소스의 집합체에 대해 이펙트를 허가하거나 거부하는 방식으로 설정하고 이를 JSON 방식으로 나열한다.

### AWS IAM 정책의 기본 요소

IAM에서 사용 가능한 정책의 기본 요소는 다음 세 가지가 있다.

* 이펙트: 허가인 경우 Allow, 거부인 경우 Deny 기재
* 액션: 허가하거나 거부할 액션 API 기재
* 리소스: 허가하거나 거부할 리소스를 ARN 형식으로 기재

아무것도 지정하지 않으면 묵시적인 거부로 인식한다. 또한

> 명시적 Deny > 명시적 Allow > 묵시적 Deny

의 우선 순위로 적용된다. 또 정책을 지정할 때 배열 형태로 나타낼 수 있고, API명이나 리소스명에 와일드카드를 사용할 수 있다. 예를 들어 Action에 Get으로 시작하는 API 전체를 지정하고 싶다면 `s3:Get*` 과 같이 표기할 수 있다.

### AWS IAM 정책의 기타 요소

* Condition
* Version
* ID
* Statement
* Statement ID
* Principal
* NotPrincipal, NotAction 등

### AWS IAM의 정책 설정 예
> {
>   "Effect" : "Allow",
>   "Action" : "s3:*",
>   "Resource" : "arn::aws::s3:::*
> }

를 살펴보면, Amazon s3의 모든 버킷에 대해 모든 기능을 허용한다 라는 정책이 설정되어 있다. 또한 이러한 정책들은 JSON 파일로 직접 기술해도 상관 없으나 AWS 콘솔같은 지원 툴을 사용하는게 더 효과적이다. AWS에서는 정책을 만드는 'policy generator', API의 사용 가능 여부를 쉽게 파악하도록 도와주는 'policy simulator' 등의 툴을 지원한다. 또 AWS는 하나의 정책을 여러 사용자나 그룹에 할당할 수 있어 재사용이 가능하다.

## 인증 키와 토큰

### 인증 키

사용자가 요청한 API를 실행하려면 사용자 ID와, 패스워드에 해당하는 `인증 키` 가 필요하다. AWS에서는 콘솔에서는 IAM 사용자의 패스워드로 인증하지만 API,CLI,SDK를 사용할 때는 액세스 키와 시크릿 액세스 키를 이용한다.

### 토큰

대부분의 클라우드에서는 보안을 위해 유효 기간이 있는 임시 패스워드를 발급한다. 이를 `토큰`이라고 한다. AWS에서는 STS라는 서비스가 '임시 자격 증명' 이라는 토큰을 발급한다. 토큰을 발급받고 액세스 키와 조합해서 사용한다. IAM과는 다른 컴포넌트로 되어 있어 URI 'https://sts.amazonaws.com/' 에 `GetSessionToken` API를 호출하면 토큰을 발급받을 수 있다.

### 서명

AWS같이 엔드포인트가 외부에 공개된 클라우드에서는 HTTPS를 사용하여 통신하는데, 그와 별개로 클라이언트의 실존 여부와 클라이언트로부터 전송된 데이터의 위변조 여부를 식별하기 위해 사용하는 것이 전자 서명이다. CLI, SDK를 사용할 때는 내부적으로 처리하지만 API를 직접 사용하면 전자 서명을 사용해야 한다. HTTP요청을 전자 서명하기 위해 우선 요청정보의 해시값과 요청값, 시크릿 액세스 키를 조합해서 전자 서명을 만들어야 한다. 이 때 사용하는 알고리즘이 SHA이다. 서명 값은 필요한 서명 키와 서명 문자열을 HMAC 함수를 사용해서 얻어낸다. 이 때 시크릿 엑세스 키와 페이로드를 미리 알고 있어야 한다. 이를 수행하는 샘플 프로그램을 AWS 사이트에서 제공한다. 이 서명 값을 HTTP 헤더의 Authoriztion에 설정하여 API 실행시 전자 서명이 이루어진다.

### IAM 롤과 리소스 기반 정책

리소스에 정책을 할당할 수 있는 기능이 필요할 때, IAM 롤과 리소스 기반의 정책이 필요하다. AWS 롤은 명시적으로 `IAM 역할` 또는 `IAM 롤` 이라 부른다. IAM 롤을 부여 받은 리소스는 , IAM 롤 할당 과정에서 STS가 이미 사용되어 토큰을 발급했기 때문에 인증 키 없이도 API를 실행할 수 있다. <br>
*IAM 롤*과 적용된 정책을 이해할 때 중요한 것은 이 정책이 제어를 하려는 주체를 위한 것이고 'from' 의 개념이 있다는 것이 중요하다.  EC2에 IAM 롤이 있고 그 정책 중 하나가 S3 변경 권한이면, 'Ec2에서 인증 키 없이 s3을 변경할 수 있다' 는 의미가 된다. <br>
반면, *리소스 기반 정책*은 'to' 의 개념이 중요하다. 예를 들면 s3 버킷에 리소스 기반 정책이 할당되어 있고 그 내용이 변경 허가 정책이라면, principal에 해당하는 누군가가 s3(to)를 변경할 수 있/없다는 의미이다. 이처럼 방향성에 대한 차이를 이해하는 것이 중요하다.

### 복수 테넌트에 대한 제어 권한

앞에서 AWS에서 인증 관련 리소스가 테넌트에 속하니 테넌트를 넘나드는 작업이 불가능하다고 했는데, 예외적으로 할 수 있는 방법이 있다. 정책을 통해 권한을 부여하면 여러 테넌트를 제어할 수 있게 된다. 각 테넌트의 리소스를 제어할 때 해당 테넌트의 롤에서 허용하는 것만 가능하다. 다른 테넌트의 리소스의 접근하려면, IAM 롤의 principal에 접근을 허용할 테넌트의 어카운트를 지정한 후 `AssumeRole` API를 실행하여 해당 테넌트로부터의 접근을 허용하게 만들 수 있다. AWS에서는 이를 크로스어카운트 접근이라고 한다. 단 리소스 접근을 허용하는 측에서는 부정 접근을 막기 위해 접근을 허용할 어카운트 번호를 관리하고 있어야 한다.

# 3. 페더레이션

토큰을 활용하는 방법 중 제 3의 ID에 권한을 위임하는 페더레이션 방식이 있다. API 이용 시 인증이 필요한데, 이를 효율적으로 하기 위해 많은 인터넷 서비스들이 채택하고 있는 방식이다. 페더레이션에서는 대체로 인증을 제공하는 소셜 서비스들을 ID 프로바이더라고 하고, 또 다른 ID를 사용하는 시스템이 상호 신뢰 관계를 맺는 방법으로 통합 인증을 구현하고 있다. 이는 크게 `SAML` 과 `OIDC` 로 접속하는 방식과 구글, 페이스북같이 WebID로 페더레이션 하는 방법 등이 있다.
<br>
`SAML`은 인증, 인가에 대한 정보들을 기술하는 마크업 언어다. 이를 HTTP/HTTPS로 주고받으면 통합 인증이 된다. 이 때 필요한 메타 데이터는 클라우드 측에서 제공한다.<br>
`OIDC` 는 OAuth2.0 을 채용하여 웹 API를 통한 접근을 제어한다. OpenID 가 제공하는 인증 정보를 기반으로 다른 ID와 ID 프로바이더 간 신뢰 관계를 형성한다.

# 4. 인증 관련 리소스의 컴포넌트

AWS에서는 사용자 그룹, IAM 롤에 대해 N:N으로 할당할 수 있다.